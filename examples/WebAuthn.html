<!DOCTYPE html>
<html lang="vi">
<head>

	<title>WebAuthn PWA Login</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="manifest" href="/PWA/manifest.json">

	<style>
		body {
			font-family: Arial, sans-serif;
			max-width: 600px;
			margin: 0 auto;
			padding: 20px;
			text-align: center;
		}
		input, button {
			margin: 10px;
			padding: 10px;
			font-size: 16px;
		}
		button {
			cursor: pointer;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 5px;
		}
		button:hover {
			background-color: #0056b3;
		}
	</style>
</head>
<body>

	<h1>Đăng ký và Đăng nhập với WebAuthn</h1>
	<div>Host: <span id="host"></span></div>
	<div>Hỗ trợ WebAuthn: <span id="issupport"></span></div>
	<input id="username" type="text" placeholder="Tên người dùng" required>
	<br>
	<button onclick="register()">Đăng ký</button>
	<button onclick="login()">Đăng nhập</button>

	<script>

		// Đăng ký Service Worker
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', () => {
				navigator.serviceWorker.register('/PWA/service-worker.js')
					.then(reg => console.log('Service Worker registered'))
					.catch(err => console.log('Service Worker registration failed:', err));
			});
		}

		// Hàm hỗ trợ mã hóa/giải mã Base64
		function bufferDecode(base64String) {
			return Uint8Array.from(atob(base64String), c => c.charCodeAt(0));
		}

		function bufferEncode(buffer) {
			// return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
			return btoa(String.fromCharCode(...new Uint8Array(buffer)))
				.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
		}

		var hostBE = 'https://hinnova.vn:7721'; // Host Portal Dev
		// var hostBE = 'http://localhost:5000';
		// var hostBE = 'http://192.168.1.242:7721'; // Host Site 6.0
		var username = "admin";

		document.getElementById('host').innerText = hostBE;

		// Kiểm tra hỗ trợ
		document.getElementById('issupport').innerText = window.PublicKeyCredential ? "Có" : "Không";

		// Hàm đăng ký
		async function register() {
			// const username = document.getElementById('username').value;
			// if (!username) {
			// 	alert('Vui lòng nhập tên người dùng!');
			// 	return;
			// }

			try {

				// Check window.atob
				if (window.atob == null) {
					alert('Chưa profill: window.atob');
					return;
				}

				let paramsURL = new URLSearchParams();
				paramsURL.append('username', username);
				// let url = hostBE+'/api/services/app/UserWebAuthn/GetRegisterOptions?'+paramsURL.toString();
				let url = hostBE+'/api/TokenAuth/GetRegisterOptions?'+paramsURL.toString();

				// Gửi yêu cầu lấy tùy chọn đăng ký
				const response = await fetch(url, {
					method: 'GET',
					headers: { 'Content-Type': 'application/json' },
					// credentials: 'include',
				});
				if (!response.ok)
					throw new Error('Không thể lấy tùy chọn đăng ký');

				let responseJson = await response.json();
				if (!responseJson.success || !responseJson.result || !responseJson.result.isSucceeded)
					throw new Error(responseJson.error || responseJson?.result?.message || 'Không thể lấy tùy chọn đăng ký');

				let publicKey = responseJson?.result?.data || {};
				const registerOptionStr = JSON.stringify(publicKey);

				// Chuyển đổi dữ liệu sang định dạng WebAuthn
				publicKey.challenge = bufferDecode(publicKey.challenge);
				publicKey.user.id = bufferDecode(publicKey.user.id);
				if (publicKey.excludeCredentials) {
					publicKey.excludeCredentials = publicKey.excludeCredentials.map(cred => ({
						...cred,
						id: bufferDecode(cred.id)
					}));
				}
				// if (publicKey.pubKeyCredParams) {
				// 	publicKey.pubKeyCredParams = publicKey.pubKeyCredParams.map(item => ({
				// 		...item,
				// 		type: 'public-key' // Sửa "0" thành "public-key"
				// 	}));
				// }
				if (publicKey.authenticatorSelection) {
					publicKey.authenticatorSelection = {
						authenticatorAttachment: "platform", // Chỉ sử dụng authenticator của thiết bị (Touch ID/FaceID)
						residentKey: "required", // Chỉ sử dụng authenticator có chứa thông tin lưu trữ
						userVerification: "preferred", // Yêu cầu xác minh người dùng (sinh trắc học)
					}
				}
				// Map Enum publicKey.attestation
				// if (publicKey.attestation != null) {
				// 	let mapVal = ['none', 'indirect', 'direct', 'enterprise']; // Map Enum
				// 	publicKey.attestation = mapVal[publicKey.attestation];
				// }
				// Xóa icon nếu ko có, ko để null
				if (publicKey.rp.icon == null)
					delete publicKey.rp.icon;
				console.log('[LOG register] publicKey:', publicKey);

				// Gọi WebAuthn API để tạo thông tin xác thực
				const credential = await navigator.credentials.create({ publicKey });
				console.log('[LOG register] credential:', credential);

				const attestationResponse = {
					id: credential.id,
					rawId: coerceToBase64Url(credential.rawId),
					type: credential.type,
					// extensions: credential.getClientExtensionResults(),
					attestationObject: coerceToBase64Url(credential.response.attestationObject),
					clientDataJSON: coerceToBase64Url(credential.response.clientDataJSON),
					// transports: credential.response.getTransports()
					registerOption: registerOptionStr,
				};
				console.log('[LOG register] attestationResponse:', attestationResponse);

				// Gửi phản hồi tới server
				url = hostBE+'/api/TokenAuth/Registration';
				// url = hostBE+'/api/services/app/UserWebAuthn/Registration';
				const completeResponse = await fetch(url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(attestationResponse),
					// credentials: 'include',
				});
				console.log('[LOG register] completeResponse:', completeResponse);
				if (!completeResponse.ok)
					throw new Error('Lỗi đăng ký');

				const result = await completeResponse.json();
				console.log('[LOG register] result:', result);

				if (result?.result?.data != null) {
					alert('Đăng ký thành công!');
				} else {
					alert('Đăng ký thất bại: ' + result.errorMessage);
				}
			}
			catch (error) {
				console.error('Lỗi đăng ký:', error);
				alert('Đăng ký thất bại: ' + error.message);
			}
		}

		// Hàm đăng nhập
		async function login() {
			// const username = document.getElementById('username').value;
			// if (!username) {
			// 	alert('Vui lòng nhập tên người dùng!');
			// 	return;
			// }

			try {

				let paramsURL = new URLSearchParams();
				paramsURL.append('username', username);
				// let url = hostBE+'/api/services/app/UserWebAuthn/GetLoginOptions?'+paramsURL.toString();
				let url = hostBE+'/api/TokenAuth/GetLoginOptions?'+paramsURL.toString();

				// Gửi yêu cầu lấy tùy chọn đăng nhập
				const response = await fetch(url, {
					method: 'GET',
					headers: { 'Content-Type': 'application/json' },
					// credentials: 'include',
				});
				if (!response.ok)
					throw new Error('Không thể lấy tùy chọn đăng nhập');

				let responseJson = await response.json();
				if (!responseJson.success || !responseJson.result || !responseJson.result.isSucceeded)
					throw new Error(responseJson.error || responseJson?.result?.message || 'Không thể lấy tùy chọn đăng nhập');

				let publicKey = responseJson?.result?.data || {};
				const loginOptionStr = JSON.stringify(publicKey);

				// Chuyển ENUM publicKey.userVerification
				// if (publicKey.userVerification != null) {
				// 	let mapVal = ['required', 'preferred', 'discouraged']; // Map Enum
				// 	publicKey.userVerification = mapVal[publicKey.userVerification];
				// }

				// Chuyển đổi dữ liệu
				publicKey.challenge = coerceToArrayBuffer(publicKey.challenge);
				if (publicKey.allowCredentials) {
					publicKey.allowCredentials = publicKey.allowCredentials.map(cred => ({
						...cred,
						id: coerceToArrayBuffer(cred.id),
						// type: 'public-key',
						transports: cred.transports || []
					}));
				}
				console.log('[LOG login] publicKey:', publicKey);

				// Gọi WebAuthn API để xác thực
				const credential = await navigator.credentials.get({ publicKey });
				console.log('[LOG login] credential:', credential);

				// Chuẩn bị dữ liệu gửi lại server
				const assertionResponse = {
					id: credential.id,
					rawId: coerceToBase64Url(credential.rawId),
					type: credential.type,
					authenticatorData: coerceToBase64Url(credential.response.authenticatorData),
					clientDataJSON: coerceToBase64Url(credential.response.clientDataJSON),
					signature: coerceToBase64Url(credential.response.signature),
					userHandle: credential.response.userHandle ? coerceToBase64Url(credential.response.userHandle) : null,
					loginOption: loginOptionStr,
					username: username,
				};
				console.log('[LOG login] assertionResponse:', assertionResponse);

				// Gửi phản hồi tới server
				// url = hostBE+'/api/services/app/UserWebAuthn/Login';
				url = hostBE+'/api/TokenAuth/LoginWebAuthn';
				const completeResponse = await fetch(url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(assertionResponse),
					// credentials: 'include',
				});
				console.log('[LOG login] completeResponse:', completeResponse);
				if (!completeResponse.ok)
					throw new Error('Lỗi đăng nhập');

				const result = await completeResponse.json();
				console.log('[LOG login] result:', result);

				if (!result
					|| !result.success
					|| !result.result
					|| !result.result.isSucceeded
					|| !result.result.data
				) {
					alert('Đăng nhập thất bại: ' + result.errorMessage);
					return;
				}

				console.log('[LOG login] final', result.result.data);

				alert('Đăng nhập thành công!');
			}
			catch (error) {
				console.error('Lỗi đăng nhập:', error);
				alert('Đăng nhập thất bại: ' + error.message);
			}
		}
		coerceToArrayBuffer = function (thing, name) {
			if (typeof thing === "string") {
				// base64url to base64
				thing = thing.replace(/-/g, "+").replace(/_/g, "/");

				// base64 to Uint8Array
				var str = window.atob(thing);
				var bytes = new Uint8Array(str.length);
				for (var i = 0; i < str.length; i++) {
						bytes[i] = str.charCodeAt(i);
				}
				thing = bytes;
			}

			// Array to Uint8Array
			if (Array.isArray(thing)) {
				thing = new Uint8Array(thing);
			}

			// Uint8Array to ArrayBuffer
			if (thing instanceof Uint8Array) {
				thing = thing.buffer;
			}

			// error if none of the above worked
			if (!(thing instanceof ArrayBuffer)) {
				throw new TypeError("could not coerce '" + name + "' to ArrayBuffer");
			}

			return thing;
		};
		coerceToBase64Url = function (thing) {
				// Array or ArrayBuffer to Uint8Array
				if (Array.isArray(thing)) {
						thing = Uint8Array.from(thing);
				}

				if (thing instanceof ArrayBuffer) {
						thing = new Uint8Array(thing);
				}

				// Uint8Array to base64
				if (thing instanceof Uint8Array) {
						var str = "";
						var len = thing.byteLength;

						for (var i = 0; i < len; i++) {
								str += String.fromCharCode(thing[i]);
						}
						thing = window.btoa(str);
				}

				if (typeof thing !== "string") {
						throw new Error("could not coerce to string");
				}

				// base64 to base64url
				// NOTE: "=" at the end of challenge is optional, strip it off here
				thing = thing.replace(/\+/g, "-").replace(/\//g, "_").replace(/=*$/g, "");

				return thing;
		};
	</script>
</body>
</html>