<!DOCTYPE html>
<html>
<head>

	<title>Sprite Editor</title>

	<meta charset="UTF-8" />

	<script src="/lib/jquery/jquery-3.7.1.min.js"></script>
	<link href="/lib/fontawesome-6.7.2/css/all.min.css" type="text/css" rel="stylesheet" />

	<link href="/lib/gridstack-12.3.3/gridstack.min.css" rel="stylesheet"/>
	<script src="/lib/gridstack-12.3.3/gridstack-all.js"></script>

	<style>
		body { margin: 0; height: 100vh; }

		/* GridStack Theme 1 */
		.grid-stack { background: #eee; }
		.grid-stack-item-content {
			color: #2c3e50;
			text-align: center;
			background-color: #a5c1e5;
			border: 2px solid #00000080;
			overflow: hidden !important;

			.grid-stack-item-image {
				width: 92px;
				height: 92px;
			}
			.grid-stack-item-title {
				position: absolute;
				bottom: 10px;
				left: 50%;
				transform: translateX(-50%);
				font-size: x-small;
				font-weight: bold;
				text-shadow: 0 0 5px white;
			}
		}
		.grid-stack-static {
			.grid-stack-item-content { background-color: #f3f3f3; }
		}
	</style>
</head>
<body>

	<div style="height:100%;display:flex;">

		<!-- Main Content -->
		<div style="flex:1;background-color:#ebfcf6;">

			<canvas id="render" style="width:100px;height:100px"></canvas>

		</div>

		<!-- Assets Content -->
		<div style="width:400px;background-color:azure;">
			<div class="grid-stack"></div>
		</div>
	</div>

	<script type="module">
		import mtAuthen from '/common/authen.js';
		import mtFile from '/common/file.js';

		var mt = {
			p_authen: mtAuthen,
			p_file: mtFile,

			mgr: {
				d_assets: {},
				d_class: {},
				d_tiles: {},

				async load() {
					let baseFolder = '/2D';

					// Load file assets
					let contentAssets = await mt.p_file.read('text', baseFolder + '/assets.txt');
					let splitAssets = contentAssets.split('\n'); // Chia thành từng dòng
					// console.log('[mt.mgr.init]', { splitAssets }); // Log

					for (let fileAsset of splitAssets) {
						fileAsset = fileAsset.trim();
						if (fileAsset.length == 0 || fileAsset.startsWith(';')) // Bỏ qua dòng trống và comment
							continue;

						// Lấy folder
						fileAsset = fileAsset.replace('\\', '/'); // Chuyển \ thành /
						let posFolder = fileAsset.lastIndexOf('/');
						let folderAsset = fileAsset.substring(0, posFolder);

						// Đọc dữ liệu sprite
						let packAsset = await mt.p_file.read('json', baseFolder + fileAsset);
						console.log('[mt.mgr.init]', { packAsset });

						// Load image
						for (let assetId in packAsset.assets) {
							let asset = packAsset.assets[assetId];
							asset.file = baseFolder + folderAsset + asset.file;
							// let linkImage = baseFolder + folderAsset + asset.file;
							// console.log('[mt.mgr.init]', { linkImage }); // Log

							// Load Image
							mt.utils.loadImage(asset.file).then(img => asset.image = img); // Bất đồng bộ để tối ưu
							// asset.image = await mt.utils.loadImage(linkImage); // Đồng bộ
						}

						// Lưu lại
						this.d_assets = Object.assign(this.d_assets, packAsset.assets);
					}

					// Render Assets
					mt.assets.load();
				},
			},
			assets: {
				p_grid: null,

				init() {

					// GridStack
					GridStack.renderCB = (el, w) => el.innerHTML = w.content;
					this.p_grid = GridStack.init({
						column: 4,
						cellHeight: 100,
						staticGrid: true,
						float: false,
						disableResize: true,
						acceptWidgets: true,
						removable: false,
						lazyLoad: true,
						margin: 2,
					});
				},
				load() {

					let listAsset = [];
					for (let assetId in mt.mgr.d_assets) {
						let asset = mt.mgr.d_assets[assetId];

						listAsset.push({
							id: assetId,
							// content: `<div style="width:64px;height:64px;background-repeat:no-repeat;background-image:url("${asset.file}");background-position:0px 0px;"></div>`,
							content: `
								<div class="grid-stack-item-image" style="background:url('${asset.file}') no-repeat center / contain;"></div>
								<span class="grid-stack-item-title">${assetId}</span>
							`,
						});
					}
					console.log('[mt.assets.load]', { listAsset });

					this.p_grid.load(listAsset);
				}
			},
			render: {
				c_render: null,
				p_ctx: null,
				p_image: null,
				m_lastTime: 0,
				m_fps: 60,

				init() {
					this.c_canvas = document.getElementById('render');
					this.p_ctx = this.c_canvas.getContext('2d');
					this.p_image = new Image();
					this.p_image.src = '/2D/res/Cute_Fantasy_Free/Enemies/Skeleton.png';

					function drawFrame(frameX, frameY) {
						let self = mt.render;
						self.p_ctx.clearRect(0, 0, self.c_canvas.width, self.c_canvas.height);
						self.p_ctx.drawImage(self.p_image,
							frameX * frameWidth, frameY * frameHeight,
							frameWidth, frameHeight,
							x, y, frameWidth, frameHeight
						);
					}

				},
				animate(currentTime) {
					let self = mt.render;
					const deltaTime = currentTime - self.m_lastTime;
					const frameDuration = 1000 / self.fps;

					if (deltaTime >= frameDuration) {
						const col = frameIndex % 6; // #TODO
						const row = Math.floor(frameIndex / 10); // #TODO
						const sx = col * frameWidth;
						const sy = row * frameHeight;
						self.p_ctx.drawImage(
							self.p_image,
							sx, sy, frameWidth, frameHeight,
							dx, dy, destWidth, destHeight
						);
						this.drawFrame(this.currentFrame);
						this.currentFrame = (this.currentFrame + 1) % this.totalFrames;
						this.lastTime = currentTime;
					}

					window.requestAnimationFrame((time) => this.animate(time));
				},
				run() {
					// ctx.drawImage(
					// 	spriteSheet,
					// 	sx, sy, frameWidth, frameHeight,
					// 	dx, dy, destWidth, destHeight
					// );
				},
			},
			utils: {
				loadImage(url) {
					return new Promise((resolve, reject) => {
						const img = new Image();
						img.onload = () => resolve(img);
						img.onerror = reject;
						img.src = url;
					});
				},
			},

			async init() {

				// Bind Global
				window.mt = this;

				// Init
				this.assets.init();

				// Load
				await this.mgr.load();
			},
		};
		document.addEventListener('DOMContentLoaded', () => mt.init());
	</script>
</body>
</html>