<!DOCTYPE html>
<html>
<head>

	<title>Full Calendar</title>

	<meta charset='utf-8' />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="/lib/jquery/jquery-3.7.1.min.js"></script>
	<link href="/lib/fontawesome-6.7.2/css/all.min.css" type="text/css" rel="stylesheet">
	<link href="/lib/sweetalert2-11.22.4/sweetalert2.css" type="text/css" rel="stylesheet">
	<script src="/lib/sweetalert2-11.22.4/sweetalert2.all.min.js"></script>
	<script src='/lib/fullcalendar-6.1.18/index.global.min.js'></script>
	<!-- <script src='/lib/fullcalendar-scheduler-6.1.18/index.global.min.js'></script> -->
	<link href="/lib/mt/json-editor/mt-style.css" type="text/css" rel="stylesheet">
	<script src="/lib/json-editor-2.15.2/jsoneditor.min.js"></script>
	<link href="/lib/flatpickr/flatpickr.min.css" type="text/css" rel="stylesheet">
	<script src="/lib/flatpickr/flatpickr.min.js"></script>
	<script src="/lib/flatpickr/l10n/vn.js"></script>

	<style>
		body {
			margin: 0;
			padding: 0;
			height: 100vh;
		}

		/* Calendar */
		#calendar {
			margin: 16px;
		}

		/* Modal */
		.swal2-html-container {
			text-align: left;
		}
	</style>
</head>
<body>

	<!--
		https://fontawesome.com/v6/search?o=r
		https://github.com/json-editor/json-editor
	 -->

	<div id='calendar'></div>

	<script type="module">
		import mtAuthen from '/common/authen.js';
		import JsonEditorEX from '/lib/mt/json-editor/mt-script.js';

		var mt = {
			h_debug: true,
			h_pathDB: 'res/DB/events/', // Link Data Client
			p_authen: mtAuthen,
			d_event: {},

			// Module
			mgr: {
				m_clientPath: '', // Đường dẫn client
				d_event: {},

				async loadFromJson(year) {
					try {

						if (year == null || year < 1000 || year > 3000)
							year = new Date().getFullYear();

						// Authen
						if (mt.p_authen.checkAuthn() == false)
							return;

						// DB Path
						let listEvent = [];
						let urlDB = '/' + mt.h_pathDB + year + '.json';

						// Call API
						let response = await fetch(urlDB, { method: 'GET' });
						if (!response.ok) {
							if (response.status == 404) { } // skip
							else
								throw { error: true, msg: await response.text() };
						}
						else
							listEvent = await response.json();

						// Log
						mt.h_debug && console.log('[mt.mgr.loadFromJson]', { listEvent });
					}
					catch (ex) {
						console.error('[mt.mgr.loadFromJson] Exception', ex);
					}
				},
				async saveToJson(year) {
					try {

						if (year == null || year < 1000 || year > 3000)
							throw { error: true, msg: "Năm không hợp lệ" };

						// Kiểm tra và lấy client path
						if (this.m_clientPath.length == 0) {
							let response = await fetch('/file/getClientPath', {
								method: 'GET',
								headers: { 'Authorization': 'Bearer '+this.p_authen.getToken() },
							});
							if (!response.ok)
								throw { error: true, msg: await response.text() };

							this.m_clientPath = await response.text();
						}

						// Call API - Lưu dữ liệu
						let paramURL = new URLSearchParams();
						paramURL.set('file', this.m_clientPath + '/' + this.h_pathDB);
						paramURL.set('force', true);
						let responseSave = await fetch('/file/writeText?' + paramURL.toString(), {
							method: 'POST',
							headers: {
								'Content-Type': 'text/plain',
								'Authorization': 'Bearer '+this.p_authen.getToken(),
							},
							body: JSON.stringify(this.d_wallpaper),
						});
						if (!responseSave.ok) {
							let errorMessage = await responseSave.text();
							this.toast('error', errorMessage);
							console.error(errorMessage);
							return;
						}

						this.toast('success', "Lưu dữ liệu ảnh thành công.");
					}
					catch (ex) {
						console.error('[mt.mgr.saveToJson] Exception', ex);
					}
				},
			},
			calendar: {
				m_calendar: null,

				// Method
				init() {

					let calendarEl = document.getElementById('calendar');
					this.m_calendar = new FullCalendar.Calendar(calendarEl, {
						initialView: 'dayGridMonth',
						initialDate: '2024-12-08', // #DEBUG
						locale: 'vi',
						timeZone: 'Asia/Ho_Chi_Minh',
						// Toolbar
						headerToolbar: {
							left: 'prev,next today',
							center: 'title',
							right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
						},
						// UI Setting
						firstDay: 1,
						weekNumbers: true,
						businessHours: false, // Sẫm màu 2 ngày cuối tuần
						showNonCurrentDates: false, // Sâm 4màu các ngày ko thuộc tháng
						buttonText: { // Phiên dịch
							today: 'Hôm nay',
							month: 'Tháng',
							week: 'Tuần',
							day: 'Ngày',
							list: 'Sự kiện'
						},
						// Other
						editable: false,
						selectable: true,
						dayMaxEvents: true, // allow "more" link when too many events
						// Data
						events: [],
						// Register Event
						datesSet: (info) => this.changeDate(info),
						eventClick: (info) => this.eventClick(info),
						dateClick: () => this.dateClick(),
					});
					this.m_calendar.render();
				},
				changeDate(info) { // khi đổi tháng, kiểu view, ngày, ...

					// Lấy thông tin tháng hiện tại
					var currentMonth = info.view.currentStart.getMonth() + 1;
					var currentYear = info.view.currentStart.getFullYear();
					mt.loadData(currentMonth, currentYear); // No Await
				},
				eventClick(info) { // khi Click vào sự kiện
					mt.h_debug && console.log('eventClick:', info.event);

					let eventData = info.event.extendedProps;
					mt.form.open(eventData);
				},
				dateClick() { // khi Click vào ngày
					// alert('a day has been clicked!');
				},
			},
			form: {
				m_editor: null, // Json Editor

				// Method
				init() {

					// Init Editor
					// JsonEditorEX.RateRegister();
				},
				async open(eventData) {

					// Open Modal
					let result = await Swal.fire({
						title: 'Sự kiện',
						html: '<div id="json-editor" class="json-editor"></div>',
						showCancelButton: true,
						confirmButtonText: 'Lưu',
						cancelButtonText: 'Đóng',
						// showClass: {
						// 	popup: '',
						// },
						// hideClass: {
						// 	popup: '',
						// },
						didOpen: () => this.initForm(eventData),
						didClose: () => this.m_editor.destroy(),
						preConfirm: () => {
							try {
								let data = this.m_editor.getValue();
								return this.cv_form2obj(data);
							}
							catch (ex) {
								Swal.showValidationMessage("Dữ liệu nhập chưa hợp lệ!");
								console.error('[mt.form.open.preConfirm] Exception:', ex);
							}
						}
					});
					if (result.isConfirmed)
						this.onSave(result.value);
				},
				initForm(eventData) {

					// Init Form
					const element = document.getElementById('json-editor');
					this.m_editor = new JSONEditor(element, {
						use_name_attributes: false,
						theme: 'barebones',
						iconlib: 'fontawesome5',
						disable_edit_json: true,
						disable_properties: true,
						disable_collapse: true,
						schema: {
							title: 'Event Calendar',
							type: 'object',
							required: [],
							properties: {
								'id': { type: 'string', format: 'hidden', options: { titleHidden: true } },
								'name': { title: 'Name', type: 'string', format: 'text' },
								'date': { title: 'Date', type: 'string', format: 'date', options: { flatpickr: {
									locale: 'vn',
									altInput: true,
									altFormat: 'd/m/Y',
									dateFormat: 'Y-m-d',
								}}},
							},
						},
						startval: this.cv_obj2form(eventData),
					});
				},
				onSave(data) {

					console.log("Dữ liệu đã nhập:", data);
					Swal.fire("Đã lưu!", JSON.stringify(data), "success");
				},
				cv_obj2form(raw) {
					return {
						id: raw.id,
						name: raw.name,
						date: mt.cv_event2calendar(raw),
					};
				},
				cv_form2obj(raw) {
					let dateEvent = mt.cv_calendar2event(raw.date);
					return {
						id: Number.parseInt(raw.id),
						name: raw.name,
						...dateEvent,
					};
				},
			},
			utils: {
				p_toast: null, // Sweetalert2 - Toast

				init() {

					// Init Sweetlert2
					this.p_toast = Swal.mixin({
						toast: true,
						position: 'bottom-end',
						showConfirmButton: false,
						timer: 3000,
						timerProgressBar: true,
						didOpen: (toast) => {
							toast.onmouseenter = Swal.stopTimer;
							toast.onmouseleave = Swal.resumeTimer;
						},
					});
				},
				toast(type, msg) {

					let title = '';
					switch (type) {
						case 'info':
							title = "Thông báo";
							break;
						case 'success':
							title = "Thành công";
							break;
						case 'warning':
							title = "Cảnh báo";
							break;
						case 'error':
							title = "Lỗi";
							break;
						default:
							throw { error: true, msg: "Type không hợp lệ!" };
					}

					// Prepare
					let opts = {
						icon: type,
						title: msg,
					};

					// Show Toast
					this.p_toast.fire(opts);
				},
			},

			// Method
			async init() {

				// Bind Global
				window.mt = this;

				// Init
				await this.p_authen.init();
				this.form.init();
				this.calendar.init();
				this.utils.init();

				// First load
				this.mgr.loadFromJson();
			},
			async loadData(month, year) { // Tải dữ liệu sự kiện

				if (month == null || year == null) {
					let viewDate = this.getViewDate();
					month = viewDate.getMonth()+1;
					year = viewDate.getFullYear();
				}

				// Kiểm tra có data chưa
				let keyData = `${year}_${month}`;
				let listEventAvailable = this.d_event[keyData];
				if (listEventAvailable != null)
					return; // Đã có data

				// Check Authn
				if (!this.p_authen.checkAuthn())
					return;

				// Call API
				const response = await fetch('/database/query', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': 'Bearer ' + this.p_authen.getToken(),
					},
					body: JSON.stringify({
						"database": "calendar",
						"sql": `
							SELECT id, name, day, month, year
							FROM calendar
							WHERE month = ${month} AND year = ${year}
						`
					}),
				});
				const listCalendar = await response.json();
				this.h_debug && console.log('listCalendar', listCalendar);

				// Lưu lại
				this.d_event[keyData] = listCalendar;

				// Load to calendar
				let listEvent = listCalendar.map(e => {
					return {
						id: e.id,
						title: e.name,
						start: this.cv_event2calendar(e),
						extendedProps: e,
					};
				});
				this.h_debug && console.log('listEvent', listEvent);

				// Thêm vào lịch để hiển thị
				this.calendar.m_calendar.addEventSource(listEvent);
			},
			saveForm(event) {
				event.preventDefault(); // Ngăn form reload trang

				const dataObject = this.form.get();
				console.log("Dữ liệu từ form (FormData):", dataObject);

				// // Lấy giá trị từ form
				// var title = document.getElementById('title').value;
				// var startDate = document.getElementById('startDate').value;
				// var startTime = document.getElementById('startTime').value;
				// var endDate = document.getElementById('endDate').value;
				// var endTime = document.getElementById('endTime').value;
				// var allDay = document.getElementById('allDay').checked;

				// // Tạo đối tượng sự kiện
				// var event = {
				// 	title: title,
				// 	allDay: allDay
				// };

				// // Xử lý ngày giờ bắt đầu
				// if (allDay) {
				// 	event.start = startDate;
				// 	if (endDate) {
				// 		// Thêm 1 ngày cho endDate nếu là sự kiện cả ngày
				// 		var endDateObj = new Date(endDate);
				// 		endDateObj.setDate(endDateObj.getDate() + 1);
				// 		event.end = endDateObj.toISOString().split('T')[0];
				// 	}
				// }
				// else {
				// 	event.start = startDate + (startTime ? 'T' + startTime + ':00' : 'T00:00:00');
				// 	if (endDate && endTime) {
				// 		event.end = endDate + 'T' + endTime + ':00';
				// 	} else if (endDate) {
				// 		event.end = endDate + 'T00:00:00';
				// 	}
				// }

				// // Thêm sự kiện vào FullCalendar
				// calendar.addEvent(event);

				// // Reset form
				// document.getElementById('eventForm').reset();
			},

			// Get / Set
			getViewDate() { // Lấy thời gian đang xem của lịch (class Date)
				return this.m_calendar.getDate();
			},

			// Utils
			cv_event2calendar(data) { // Chuyển date event thành date calendar
				if (data == null)
					return '';
				return `${data.year}-${String(data.month).padStart(2, '0')}-${String(data.day).padStart(2, '0')}`;
			},
			cv_calendar2event(date) { // Chuyển date calendar thành date event
				if (date == null || date.length == 0)
					return null;

				return {
					day: Number.parseInt(date.substr(8, 2)),
					month: Number.parseInt(date.substr(5, 2)),
					year: Number.parseInt(date.substr(0, 4)),
				};
			},
		};
		document.addEventListener('DOMContentLoaded', () => mt.init());
	</script>

</body>
</html>
