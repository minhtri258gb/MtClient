<!DOCTYPE html>
<html>
<head lang="vi">

	<title>FullCalendar</title>

	<meta charset='utf-8' />
	<meta name="locale" content="vi-VN">

	<script src='/lib/fullcalendar-6.1.18/index.global.min.js'></script>
	<!-- <script src='/lib/fullcalendar-scheduler-6.1.18/index.global.min.js'></script> -->

	<link href="/lib/fontawesome-5.15.4/css/all.min.css" type="text/css" rel="stylesheet">

	<link href="/lib/mt/json-editor/mt-style.css" type="text/css" rel="stylesheet">
	<script src="/lib/json-editor-2.15.2/jsoneditor.min.js"></script>

	<link href="/lib/tingle/tingle.min.css" type="text/css" rel="stylesheet">
	<link href="/lib/mt/tingle/mt-style.css" type="text/css" rel="stylesheet">
	<script src='/lib/tingle/tingle.min.js'></script>

	<style>
		body {
			margin: 0;
			padding: 0;
			height: 100vh;
		}
		#calendar {
			margin: 16px;
		}
	</style>
</head>
<body>

	<!--
		https://fontawesome.com/v5/search
	 -->

	<div id='calendar'></div>

	<script type="module">
		import mtAuthen from '/common/authen.js';
		import JsonEditorEX from '/lib/json-editor-2.15.2/mt-script.js';
		var mt = {
			h_debug: false,
			p_authen: mtAuthen,
			d_event: {},

			calendar: {
				m_calendar: null,

				// Method
				init() {

					let calendarEl = document.getElementById('calendar');
					this.m_calendar = new FullCalendar.Calendar(calendarEl, {
						initialView: 'dayGridMonth',
						initialDate: '2024-12-08', // #DEBUG
						locale: 'vi',
						timeZone: 'Asia/Ho_Chi_Minh',
						// Toolbar
						headerToolbar: {
							left: 'prev,next today',
							center: 'title',
							right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
						},
						// UI Setting
						firstDay: 1,
						weekNumbers: true,
						businessHours: false, // Sẫm màu 2 ngày cuối tuần
						showNonCurrentDates: false, // Sâm 4màu các ngày ko thuộc tháng
						buttonText: { // Phiên dịch
							today: 'Hôm nay',
							month: 'Tháng',
							week: 'Tuần',
							day: 'Ngày',
							list: 'Sự kiện'
						},
						// Other
						editable: false,
						selectable: true,
						dayMaxEvents: true, // allow "more" link when too many events
						// Data
						events: [],
						// Register Event
						datesSet: (info) => this.changeDate(info),
						eventClick: (info) => this.eventClick(info),
						dateClick: () => this.dateClick(),
					});
					this.m_calendar.render();
				},
				changeDate(info) { // khi đổi tháng, kiểu view, ngày, ...

					// Lấy thông tin tháng hiện tại
					var currentMonth = info.view.currentStart.getMonth() + 1;
					var currentYear = info.view.currentStart.getFullYear();
					mt.loadData(currentMonth, currentYear); // No Await
				},
				eventClick(info) { // khi Click vào sự kiện
					mt.h_debug && console.log('eventClick:', info.event);

					mt.form.set(info.event.extendedProps); // Load event lên Form
					mt.form.open();
				},
				dateClick() { // khi Click vào ngày
					// alert('a day has been clicked!');
				},
			},
			form: {
				m_modal: null, // Tingle Modal
				m_editor: null, // Json Editor

				// Method
				init() {

					// Init Modal
					this.m_modal = new tingle.modal({
						footer: false,
						stickyFooter: false,
						closeMethods: ['button', 'escape'], // 'overlay'
						closeLabel: "Đóng",
						onOpen: function() {
							// console.log('modal opened');
						},
						onClose: function() {
							// console.log('modal closed');
						},
						beforeClose: function() {
							// Return true to close the modal, false to prevent closing
							return true;
						}
					});
					this.m_modal.setContent('<div id="modalContent" class="json-editor"></div>');

					// Init Editor
					// JsonEditorEX.RateRegister();
					JSONEditor.defaults.callbacks = {
						button: {
							'onSave': (jseditor, e) => this.onSave(jseditor, e),
						}
					};
					const element = document.getElementById('modalContent');
					this.m_editor = new JSONEditor(element, {
						use_name_attributes: false,
						theme: 'barebones',
						iconlib: 'fontawesome5',
						disable_edit_json: true,
						disable_properties: true,
						disable_collapse: false,
						schema: {
							title: 'Event Calendar',
							type: 'object',
							required: [],
							properties: {
								'id': { title: ' ', type: 'string', format: 'hidden' },
								'name': { title: 'Name', type: 'string', format: 'text' },
								'date': { title: 'Date', type: 'string', format: 'date' },
								'btnSave': { title: 'Save', type: 'string', format: 'button', options: { button: {
									text: 'Save', icon: 'sd-card', action: 'onSave', validated: true
								}}},
							}
						},
					});
				},
				get() {
					let raw = this.m_editor.getValue();
					let dateEvent = mt.convert_dateCalendarToEvent(raw.date);
					return {
						id: Number.parseInt(raw.id),
						name: raw.name,
						...dateEvent,
					};
				},
				set(data) {
					this.m_editor.setValue({
						id: data.id,
						name: data.name,
						date: mt.convert_dateEventToCalendar(data),
					});
				},
				open() {
					this.m_modal.open();
				},
				close() {
					this.m_modal.close();
				},
				onSave(jseditor, e) {
					let data = this.get();
					console.log(data);
				},
			},

			// Method
			async init() {

				// Bind Global
				window.mt = this;

				// Authen
				await this.p_authen.promt();

				// Form
				this.form.init();

				// Init Calendar
				this.calendar.init();
			},
			async loadData(month, year) { // Tải dữ liệu sự kiện

				if (month == null || year == null) {
					let viewDate = this.getViewDate();
					month = viewDate.getMonth()+1;
					year = viewDate.getFullYear();
				}

				// Kiểm tra có data chưa
				let keyData = `${year}_${month}`;
				let listEventAvailable = this.d_event[keyData];
				if (listEventAvailable != null)
					return; // Đã có data

				// Check Authn
				if (!this.p_authen.checkAuthn())
					return;

				// Call API
				const response = await fetch('/database/query', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': 'Bearer ' + this.p_authen.getToken(),
					},
					body: JSON.stringify({
						"database": "calendar",
						"sql": `
							SELECT id, name, day, month, year
							FROM calendar
							WHERE month = ${month} AND year = ${year}
						`
					}),
				});
				const listCalendar = await response.json();
				this.h_debug && console.log('listCalendar', listCalendar);

				// Lưu lại
				this.d_event[keyData] = listCalendar;

				// Load to calendar
				let listEvent = listCalendar.map(e => {
					return {
						id: e.id,
						title: e.name,
						start: this.convert_dateEventToCalendar(e),
						extendedProps: e,
					};
				});
				this.h_debug && console.log('listEvent', listEvent);

				// Thêm vào lịch để hiển thị
				this.calendar.m_calendar.addEventSource(listEvent);
			},
			saveForm(event) {
				event.preventDefault(); // Ngăn form reload trang

				const dataObject = this.form.get();
				console.log("Dữ liệu từ form (FormData):", dataObject);

				// // Lấy giá trị từ form
				// var title = document.getElementById('title').value;
				// var startDate = document.getElementById('startDate').value;
				// var startTime = document.getElementById('startTime').value;
				// var endDate = document.getElementById('endDate').value;
				// var endTime = document.getElementById('endTime').value;
				// var allDay = document.getElementById('allDay').checked;

				// // Tạo đối tượng sự kiện
				// var event = {
				// 	title: title,
				// 	allDay: allDay
				// };

				// // Xử lý ngày giờ bắt đầu
				// if (allDay) {
				// 	event.start = startDate;
				// 	if (endDate) {
				// 		// Thêm 1 ngày cho endDate nếu là sự kiện cả ngày
				// 		var endDateObj = new Date(endDate);
				// 		endDateObj.setDate(endDateObj.getDate() + 1);
				// 		event.end = endDateObj.toISOString().split('T')[0];
				// 	}
				// }
				// else {
				// 	event.start = startDate + (startTime ? 'T' + startTime + ':00' : 'T00:00:00');
				// 	if (endDate && endTime) {
				// 		event.end = endDate + 'T' + endTime + ':00';
				// 	} else if (endDate) {
				// 		event.end = endDate + 'T00:00:00';
				// 	}
				// }

				// // Thêm sự kiện vào FullCalendar
				// calendar.addEvent(event);

				// // Reset form
				// document.getElementById('eventForm').reset();
			},

			// Get / Set
			getViewDate() { // Lấy thời gian đang xem của lịch (class Date)
				return this.m_calendar.getDate();
			},

			// Utils
			convert_dateEventToCalendar(data) { // Chuyển date event thành date calendar
				if (data == null)
					return '';

				// const formattedMonth = event.month < 10 ? `0${event.month}` : event.month;
				// const formattedDay = event.day < 10 ? `0${event.day}` : event.day;

				// return `${event.year}-${formattedMonth}-${formattedDay}`;
				return `${data.year}-${String(data.month).padStart(2, '0')}-${String(data.day).padStart(2, '0')}`;
			},
			convert_dateCalendarToEvent(date) { // Chuyển date calendar thành date event
				if (date == null || date.length == 0)
					return null;

				return {
					day: Number.parseInt(date.substr(8, 2)),
					month: Number.parseInt(date.substr(5, 2)),
					year: Number.parseInt(date.substr(0, 4)),
				};
			},
		};
		document.addEventListener('DOMContentLoaded', () => mt.init());
	</script>

</body>
</html>
