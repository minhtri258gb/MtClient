<!DOCTYPE html>
<html>
<head>

	<title>Full Calendar</title>

	<meta charset='utf-8' />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="/lib/jquery/jquery-3.7.1.min.js"></script>
	<!-- <link href='/lib/bootstrap-5.3.3/bootstrap.min.css' rel='stylesheet'> -->
	<link href="/lib/fontawesome-6.7.2/css/all.min.css" type="text/css" rel="stylesheet">
	<link href="/lib/sweetalert2-11.22.4/sweetalert2.css" type="text/css" rel="stylesheet">
	<script src="/lib/sweetalert2-11.22.4/sweetalert2.all.min.js"></script>
	<script src='/lib/fullcalendar-6.1.18/index.global.min.js'></script>
	<!-- <script src='/lib/fullcalendar-scheduler-6.1.18/index.global.min.js'></script> -->
	<link href="/lib/mt/json-editor/mt-style.css" type="text/css" rel="stylesheet">
	<script src="/lib/json-editor-2.15.2/jsoneditor.min.js"></script>
	<link href="/lib/flatpickr/flatpickr.min.css" type="text/css" rel="stylesheet">
	<script src="/lib/flatpickr/flatpickr.min.js"></script>
	<script src="/lib/flatpickr/l10n/vn.js"></script>

	<style>
		body {
			margin: 0;
			padding: 0;
			height: 100vh;
		}

		/* Calendar */
		#calendar {
			margin: 16px;
		}

		/* Modal */
		.swal2-html-container {
			text-align: left;
		}
	</style>
</head>
<body>

	<!--
		https://fullcalendar.io/docs
		https://fontawesome.com/v6/search?o=r
		https://github.com/json-editor/json-editor
		https://sweetalert2.github.io
	-->

	<div id='calendar'></div>

	<script type="module">
		import mtAuthen from '/common/authen.js';
		import JsonEditorEX from '/lib/mt/json-editor/mt-script.js';

		var mt = {
			h_debug: true,
			h_pathDB: 'res/DB/calendar/', // Link Data Client
			p_authen: mtAuthen,
			d_event: {},

			// Module
			mgr: {
				m_clientPath: '', // Đường dẫn client
				d_event: {},

				async loadFromJson(year) {
					try {

						// Validate
						if (year == null || typeof year != 'number')
							throw { error: true, message: 'Số năm không hợp lệ' };

						// Authen
						if (mt.p_authen.checkAuthn() == false)
							return;

						// DB Path
						let listEvent = [];
						let urlDB = '/' + mt.h_pathDB + year + '.json';

						// Call API
						let response = await fetch(urlDB, { method: 'GET' });
						if (!response.ok) {
							if (response.status == 404) { } // skip
							else
								throw { error: true, message: await response.text() };
						}
						else
							listEvent = await response.json();

						// Save in RAM
						this.d_event[year] = listEvent;

						// Set into calendar
						mt.calendar.setEvents(listEvent);

						// Log
						mt.h_debug && console.log('[mt.mgr.loadFromJson]', { listEvent });
					}
					catch (ex) {
						console.error('[mt.mgr.loadFromJson] Exception', ex);
						throw ex;
					}
				},
				async saveToJson(year) {
					try {

						if (year == null || year < 1000 || year > 3000)
							throw { error: true, message: "Năm không hợp lệ" };

						// Kiểm tra và lấy client path
						if (this.m_clientPath.length == 0) {
							let response = await fetch('/file/getClientPath', {
								method: 'GET',
								headers: { 'Authorization': 'Bearer '+mt.p_authen.getToken() },
							});
							if (!response.ok)
								throw { error: true, message: await response.text() };

							this.m_clientPath = await response.text();
						}

						// DB Path
						let urlDB = mt.h_pathDB + year + '.json';

						// Call API - Lưu dữ liệu
						let paramURL = new URLSearchParams();
						paramURL.set('file', this.m_clientPath + '/' + urlDB);
						paramURL.set('force', true);
						let responseSave = await fetch('/file/writeText?' + paramURL.toString(), {
							method: 'POST',
							headers: {
								'Content-Type': 'text/plain',
								'Authorization': 'Bearer '+mt.p_authen.getToken(),
							},
							body: JSON.stringify(this.d_event[year]),
						});
						if (!responseSave.ok) {
							let errorMessage = await responseSave.text();
							this.toast('error', errorMessage);
							console.error(errorMessage);
							return;
						}
					}
					catch (ex) {
						console.error('[mt.mgr.saveToJson] Exception', ex);
						throw ex;
					}
				},
			},
			calendar: {
				m_calendar: null,

				// Method
				init() {

					let calendarEl = document.getElementById('calendar');
					this.m_calendar = new FullCalendar.Calendar(calendarEl, {
						initialView: 'dayGridMonth',
						// initialDate: '2024-12-08', // #DEBUG
						locale: 'vi',
						timeZone: 'Asia/Ho_Chi_Minh',
						// Toolbar
						headerToolbar: {
							left: 'prev,next today',
							center: 'title',
							right: 'addEvent dayGridMonth,timeGridWeek,timeGridDay,listWeek'
						},
						// UI Setting
						firstDay: 1,
						weekNumbers: true,
						businessHours: false, // Sẫm màu 2 ngày cuối tuần
						showNonCurrentDates: false, // Sâm 4màu các ngày ko thuộc tháng
						buttonText: { // Phiên dịch
							today: 'Hôm nay',
							month: 'Tháng',
							week: 'Tuần',
							day: 'Ngày',
							list: 'Sự kiện'
						},
						// Other
						editable: false,
						selectable: true,
						dayMaxEvents: true, // allow "more" link when too many events
						// Data
						events: [],
						// Custom Button
						customButtons: {
							addEvent: { text: 'Thêm', click: () => mt.form.open(null) },
						},
						// Register Event
						datesSet: (info) => this.changeDate(info),
						eventClick: (item) => mt.form.open(item),
						dateClick: () => this.dateClick(),
					});
					this.m_calendar.render();
				},
				setEvents(listEvent) {
					let lstData = [];
					for (let i=0, sz=listEvent.length; i<sz; i++) {
						let event = listEvent[i];
						lstData.push({
							id: i+1,
							title: event.name,
							start: event.date,
							extendedProps: event,
						});
					}
					this.m_calendar.addEventSource(lstData);
				},
				async changeDate(info) { // khi đổi tháng, kiểu view, ngày, ...
					let year = info.view.currentStart.getFullYear();
					if (mt.mgr.d_event[year] == null)
						await mt.mgr.loadFromJson(year);
				},
				dateClick() { // khi Click vào ngày
					// alert('a day has been clicked!');
				},
				getViewDate() { // Lấy thời gian đang xem của lịch (class Date)
					return this.m_calendar.getDate();
				},
				addEvent(id, data) {
					this.m_calendar.addEvent({
						id: id,
						title: data.name,
						start: data.date,
						extendedProps: data,
					});
				},
				editEvent(id, data) {
					let event = this.m_calendar.getEventById(id);
					event.setProp('title', data.name);
					event.setDates(data.date, null, { allDay: true });
					event.setExtendedProp('name', data.name);
					event.setExtendedProp('date', data.date);
				},
				removeEvent(id) {
					let event = this.m_calendar.getEventById(id);
					event.remove();
				},
			},
			form: {
				m_editor: null, // Json Editor

				// Method
				init() {

					// Init Editor
					// JsonEditorEX.RateRegister();
				},
				async open(item) {

					// Open Modal
					let result = await Swal.fire({
						title: 'Sự kiện',
						html: '<div id="json-editor" class="json-editor"></div>',
						showDenyButton: true,
						showCancelButton: true,
						confirmButtonText: 'Lưu',
						denyButtonText: 'Xóa',
						cancelButtonText: 'Đóng',
						// showClass: {
						// 	popup: '',
						// },
						// hideClass: {
						// 	popup: '',
						// },
						didOpen: () => this.initForm(item),
						didClose: () => this.m_editor.destroy(),
						preConfirm: () => {
							try {
								return this.m_editor.getValue();
							}
							catch (ex) {
								Swal.showValidationMessage("Dữ liệu nhập chưa hợp lệ!");
								console.error('[mt.form.open.preConfirm] Exception:', ex);
							}
						},
					});
					if (result.isConfirmed)
						this.onSave(result.value);
					else if (result.isDenied)
						this.onDelete({
							id: item.event.id,
							...item.event.extendedProps
						});
				},
				initForm(item) {

					let objForm = null;
					if (item != null) {
						objForm = {
							id: item.event.id,
							...item.event.extendedProps
						};
					}
					else {
						objForm = {
							id: 0,
							name: '',
							date: new Date().toISOString().substring(0, 10),
						};
					}

					// Default value
					let sysdate = new Date().toISOString().substring(0, 10);

					// Init Form
					const element = document.getElementById('json-editor');
					this.m_editor = new JSONEditor(element, {
						use_name_attributes: false,
						theme: 'barebones',
						iconlib: 'fontawesome5',
						disable_edit_json: true,
						disable_properties: true,
						disable_collapse: true,
						startval: objForm,
						schema: {
							title: 'Event Calendar',
							type: 'object',
							required: [],
							properties: {
								'id': { type: 'string', format: 'hidden', options: { titleHidden: true } },
								'name': { title: 'Name', type: 'string', format: 'text' },
								'date': { title: 'Date', type: 'string', format: 'date', options: { flatpickr: {
									locale: 'vn',
									altInput: true,
									altFormat: 'd/m/Y',
									dateFormat: 'Y-m-d',
								}}},
							},
						},
					});
				},
				async onSave(data) {
					try {

						let year = new Date(data.date).getFullYear();

						if (data.id === '0') { // Add

							if (mt.mgr.d_event[year] == null)
								await mt.mgr.loadFromJson(year);
							delete data.id;

							// Save to RAM
							mt.mgr.d_event[year].push(data);

							// Change Calendar
							let id = mt.mgr.d_event[year].length
							mt.calendar.addEvent(id, data)
						}
						else { // Update

							// Cập nhật data RAM
							let arrIndex = +data.id - 1;
							delete data.id;

							// Save to RAM
							mt.mgr.d_event[year][arrIndex] = data;

							// Change Calendar
							mt.calendar.editEvent(arrIndex+1, data);
						}

						// Save data
						await mt.mgr.saveToJson(year);

						// Notify
						mt.utils.toast('success', "Lưu dữ liệu ảnh thành công.");
					}
					catch (ex) {
						console.error('[mt.form.onSave] Exception', ex);
						mt.utils.toast('error', ex.message);
					}
				},
				async onDelete(data) {
					try {

						// Confirm Delete
						let isConfirm = await mt.utils.confirmDanger('Xác nhận xóa sự kiện!', 'Xóa');
						if (!isConfirm)
							return;

						let year = new Date(data.date).getFullYear();

						// Cập nhật data RAM
						let arrIndex = +data.id - 1;
						delete data.id;

						// Save to RAM
						mt.mgr.d_event[year].splice(arrIndex, 1);

						// Change Calendar
						mt.calendar.removeEvent(arrIndex+1);

						// Save data
						await mt.mgr.saveToJson(year);

						// Notify
						mt.utils.toast('success', "Đã xóa sự kiện.");
					}
					catch (ex) {
						console.error('[mt.form.onDelete] Exception', ex);
						mt.utils.toast('error', ex.message);
					}
				},
			},
			utils: {
				p_toast: null, // Sweetalert2 - Toast

				init() {

					// Init Sweetlert2
					this.p_toast = Swal.mixin({
						toast: true,
						position: 'bottom-end',
						showConfirmButton: false,
						timer: 3000,
						timerProgressBar: true,
						didOpen: (toast) => {
							toast.onmouseenter = Swal.stopTimer;
							toast.onmouseleave = Swal.resumeTimer;
						},
					});
				},
				toast(type, message) {

					let title = '';
					switch (type) {
						case 'info':
							title = "Thông báo";
							break;
						case 'success':
							title = "Thành công";
							break;
						case 'warning':
							title = "Cảnh báo";
							break;
						case 'error':
							title = "Lỗi";
							break;
						default:
							throw { error: true, message: "Type không hợp lệ!" };
					}

					// Prepare
					let opts = {
						icon: type,
						title: message,
					};

					// Show Toast
					this.p_toast.fire(opts);
				},
				async confirmDanger(message, action) {
					let result = await Swal.fire({
						title: message,
						icon: 'warning',
						showCancelButton: true,
						confirmButtonColor: '#d33',
						confirmButtonText: action,
						cancelButtonText: 'Hủy'
					});
					return result.isConfirmed;
				},
			},

			// Method
			async init() {

				// Bind Global
				window.mt = this;

				// Init
				await this.p_authen.init();
				this.form.init();
				this.calendar.init();
				this.utils.init();
			},
			async test() {

				// Call API - Load Data
				let response = await fetch('/calendar/2024.json', { method: 'GET' });
				if (!response.ok)
					throw { error: true, message: await response.text() };
				let lstEvent = await response.json();

				let lstProcess = [];
				for (let event of lstEvent) {

					let dayMonth = new Date(event.date);
					dayMonth.setFullYear(2000);

					lstProcess.push({
						name: event.name,
						date: dayMonth.toISOString().substring(0, 10),
						type: 'yearly',
					});
				}

				console.log({
					lstEvent,
					lstProcess,
				});
			},
		};
		document.addEventListener('DOMContentLoaded', () => mt.init());
	</script>
</body>
</html>